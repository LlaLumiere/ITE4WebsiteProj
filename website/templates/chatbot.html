<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #97CAEF;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .messenger-container {
            background-color: white;
            border-radius: 15px;
            width: 900px;
            height: 600px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .messenger-header {
            background-color: #216291;
            color: white;
            text-align: center;
            padding: 15px 0;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            font-weight: bold;
        }

        .messenger-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .message {
            padding: 10px;
            border-radius: 15px;
            margin: 10px;
            max-width: 80%;
            clear: both;
        }
                                                                                                                
        .message.bot {
            background-color: #e1f3fd;
            align-self: flex-start;
            float: left;
        }

        .message.user {
            background-color: #6fbef7;
            align-self: flex-end;
            float: right;
        }

        .messenger-input {
            display: flex;
            border-top: 1px solid #ddd;
            padding: 10px;
        }

        .messenger-input input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 20px;
            margin-right: 10px;
            outline: none;
        }

        .messenger-input button {
            background-color: #216291;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            cursor: pointer;
            outline: none;
            font-size: 16px;
        }
        ul {
        float: right;
        margin-right: 20px;
        }
        ul li{
        list-style: none;
        margin: 0 8px;
        display: inline-block;
        line-height: 80px;
        }
        ul li a {
        text-decoration: none;
        color: white;
        font-size: 20px;
        padding: 6px 15px;
        font-family: 'Arial', sans-serif;
        transition: .4s;
        }
        ul li a.active,
        ul li a:hover{
        background: #55BCC9;
        border-radius: 20px;
        }
        .create-new-chat-button {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: #216291;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px 15px;
        cursor: pointer;
        outline: none;
        font-size: 16px;
        z-index: 1; /* Ensure the button is above other elements */
    }
    .delete-chat-button {
        background-color: #ff3333; /* Red color, you can change it as needed */
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
        outline: none;
        font-size: 12px;
        margin-left: auto; /* Move the button to the right */
    }

    .messenger-container {
        position: relative;
    }
    .messenger-content {
        display: flex;
        flex-direction: column;
    }
    </style>
</head>

<body>

    <div class="messenger-container">
        <button class="create-new-chat-button" onclick="createNewChat()">Create New Chat</button>
        <button class="save-chat-button" onclick="saveChat()">Save Chat</button>
        <div class="messenger-header">Ai Assistant</div>
        <div class="messenger-messages" id="messengerMessages">
            <div class="message bot">Hello {{ user.userprofile.firstname }} {{ user.userprofile.lastname }}!</div>
        </div>
        <div class="messenger-input">
            <input type="text" placeholder="Type your message..." id="userInput">
            <button onclick="sendMessage()">Send</button>
        </div>
      </div>

<script>
    let chatHistory = []; // Array to store chat history

function sendMessage() {
    const userInput = document.getElementById('userInput').value;
    const messengerMessages = document.getElementById('messengerMessages');

    // Append the user's message
    const userMessageElem = document.createElement('div');
    userMessageElem.classList.add('message', 'user');
    userMessageElem.innerText = userInput;

    // Create an Edit button for the user's message
    const editButton = document.createElement('button');
    editButton.innerText = 'Edit';
    editButton.onclick = function () {
        editUserMessage(userMessageElem);
    };

    userMessageElem.appendChild(editButton);
    messengerMessages.appendChild(userMessageElem);

    // Use AJAX to get the bot's response
    $.ajax({
        url: '/ask/', // Endpoint at '/ask/'
        type: 'POST',
        data: { 'userInput': userInput },
        success: function (response) {
            // Append bot's response
            const botMessageElem = document.createElement('div');
            botMessageElem.classList.add('message', 'bot');
            botMessageElem.innerText = response.bot_response;
            messengerMessages.appendChild(botMessageElem);
        }
    });

    // Clear the user's input
    document.getElementById('userInput').value = '';

    // Auto scroll to the bottom
    messengerMessages.scrollTop = messengerMessages.scrollHeight;

    // Save the chat to chat history
    chatHistory.push({
        user: userInput,
        bot: response.bot_response
    });
}

function createNewChat() {
    // Create a new chat container
    const newChatContainer = document.createElement('div');
    newChatContainer.classList.add('messenger-container');
    document.body.appendChild(newChatContainer);

    // Create a new chat header
    const newChatHeader = document.createElement('div');
    newChatHeader.classList.add('messenger-header');
    newChatHeader.innerText = 'New Chat';

    // Create a delete button for the new chat
    const deleteButton = document.createElement('button');
    deleteButton.innerText = 'Delete Chat';
    deleteButton.onclick = function () {
        deleteChat(newChatContainer);
    };

    newChatHeader.appendChild(deleteButton);
    newChatContainer.appendChild(newChatHeader);

    // Create a new chat messages container
    const newChatMessages = document.createElement('div');
    newChatMessages.classList.add('messenger-messages');
    newChatMessages.id = 'newChatMessages';
    newChatContainer.appendChild(newChatMessages);

    // Create a new chat input
    const newChatInput = document.createElement('div');
    newChatInput.classList.add('messenger-input');
    newChatInput.innerHTML = `
        <input type="text" placeholder="Type your message..." id="newChatInput">
        <button onclick="sendNewChatMessage()">Send</button>
    `;
    newChatContainer.appendChild(newChatInput);

    // Populate new chat with previous chat history
    const newChatMessagesContainer = document.getElementById('newChatMessages');
    chatHistory.forEach(chat => {
        const userMessageElem = document.createElement('div');
        userMessageElem.classList.add('message', 'user');
        userMessageElem.innerText = chat.user;

        // Create an Edit button for the user's message
        const editButton = document.createElement('button');
        editButton.innerText = 'Edit';
        editButton.onclick = function () {
            editUserMessage(userMessageElem);
        };

        userMessageElem.appendChild(editButton);
        newChatMessagesContainer.appendChild(userMessageElem);

        const botMessageElem = document.createElement('div');
        botMessageElem.classList.add('message', 'bot');
        botMessageElem.innerText = chat.bot;
        newChatMessagesContainer.appendChild(botMessageElem);
    });
}

function editUserMessage(messageElem) {
    const editedMessage = prompt('Edit your message:', messageElem.innerText);
    if (editedMessage !== null) {
        messageElem.innerText = editedMessage;

        const messengerMessages = document.getElementById('messengerMessages');
            const userMessageElem = document.createElement('div');
            userMessageElem.classList.add('message', 'user');
            userMessageElem.innerText = editedMessage;
            messengerMessages.appendChild(userMessageElem);
            
            // Use AJAX to get the updated bot's response
            $.ajax({
                url: '/ask/', // Endpoint at '/ask/'
                type: 'POST',
                data: { 'userInput': editedMessage },
                success: function (response) {
                    // Append updated bot's response
                    const botMessageElem = document.createElement('div');
                    botMessageElem.classList.add('message', 'bot');
                    botMessageElem.innerText = response.bot_response;
                    messengerMessages.appendChild(botMessageElem);
                }
            });

            // Save the updated chat to chat history
            chatHistory.push({
                user: editedMessage,
                bot: response.bot_response
            });
        }
    }


function deleteChat(chatContainer) {
    chatContainer.remove();
}

function sendNewChatMessage() {
    const newChatInput = document.getElementById('newChatInput').value;
    const newChatMessages = document.getElementById('newChatMessages');

    // Append the user's message for the new chat
    const userMessageElem = document.createElement('div');
    userMessageElem.classList.add('message', 'user');
    userMessageElem.innerText = newChatInput;

    // Create an Edit button for the user's message
    const editButton = document.createElement('button');
    editButton.innerText = 'Edit';
    editButton.onclick = function () {
        editUserMessage(userMessageElem);
    };

    userMessageElem.appendChild(editButton);
    newChatMessages.appendChild(userMessageElem);

    // You can customize the AJAX request for the new chat if needed
    $.ajax({
        url: '/ask/', // Endpoint at '/ask/'
        type: 'POST',
        data: { 'userInput': newChatInput },
        success: function (response) {
            // Append bot's response
            const botMessageElem = document.createElement('div');
            botMessageElem.classList.add('message', 'bot');
            botMessageElem.innerText = response.bot_response;
            newChatMessages.appendChild(botMessageElem);
        }
    });

    // Clear the user's input for the new chat
    document.getElementById('newChatInput').value = '';

    // Auto scroll to the bottom for the new chat
    newChatMessages.scrollTop = newChatMessages.scrollHeight;
}
function saveChat() {
    const conversations = chatHistory.map(chat => ({
        user_message: chat.user,
        bot_message: chat.bot
    }));

    // Use jQuery to make an AJAX request to the Django view
    $.ajax({
    url: '/save_chat/',
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({ conversations: chatHistory }),
    success: function (response) {
        console.log(response);  // Log the response from the server
        alert("Chat saved successfully!");
    },
    error: function (error) {
        console.error(error);  // Log any errors
        alert("Error saving chat!");
    }
});
}
</script>
</body>

</html>